{% extends 'core/base.html' %}

{% block content %}
<div class="container">
    <div class="row">
      <h2>TP 5</h2>
    </div>
  </div>
  <div class="container-fluid h-100">
    <div class="card card-body shadow my-3 py-4 px-5">
        <div class="container-fluid h-100">
            <div class="row h-100">
              <div class="col"><h4>Numeros generados</h4></div>
              <div class="col-auto">
                <span class="my-auto" id="pageLegend"></span>
                <div class="d-block">
                  <button class="btn btn-sm btn-outline-secondary" onclick="displayItems(1)">&laquo;&laquo;</button>
                  <button id="prevBtn" class="btn btn-sm btn-outline-secondary" onclick="displayItems(1)">&laquo;</button>
                  <button id="nextBtn" class="btn btn-sm btn-outline-secondary" onclick="displayItems(2)">&raquo;</button>
                  <button id="lastBtn" class="btn btn-sm btn-outline-secondary">&raquo;&raquo;</button>
                </div>
              </div>
              <div class="col-12 h-100 overflow-scroll" style="max-height: 800px;" id="tableContainer">
                <table class="table h-100 table-hover table-striped">
                    <thead class="sticky-top top-0">
                    <tr>
                      <th class="border-end" scope="row" colspan="2">Gral</th>
                      <th class="border-end" scope="row" colspan="3">Llegada alumno</th>
                      <th class="border-end" scope="row" colspan="8">Fin de inscripcion</th>
                      <th class="border-end" scope="row" colspan="4">Fin de mantenimiento</th>
                      <th class="border-end" scope="row" colspan="4">Regreso de Tecnico</th>
                      <th class="border-end" scope="row" colspan="2">PC 1</th>
                      <th class="border-end" scope="row" colspan="2">PC 2</th>
                      <th class="border-end" scope="row" colspan="2">PC 3</th>
                      <th class="border-end" scope="row" colspan="2">PC 4</th>
                      <th class="border-end" scope="row" colspan="2">PC 5</th>
                      <th class="border-end" scope="row" colspan="2">PC 6</th>
                      <th class="border-end" scope="row" colspan="1">Tecnico</th>
                      <th class="border-end" scope="row" colspan="1"></th>
                      <th class="border-end" scope="row" colspan="6">Estadisticas</th>
                      <th class="border-end" scope="row" colspan="3">Alumno 1</th>
                      <th class="border-end" scope="row" colspan="3">Alumno 2</th>
                      <th class="border-end" scope="row" colspan="3">Alumno 3</th>
                      <th class="border-end" scope="row" colspan="3">Alumno 4</th>
                      <th class="border-end" scope="row" colspan="3">Alumno 5</th>
                      <th class="border-end" scope="row" colspan="3">Alumno 6</th>
                      <th class="border-end" scope="row" colspan="3">Alumno 7</th>
                      <th class="border-end" scope="row" colspan="3">Alumno 8</th>
                      <th class="border-end" scope="row" colspan="3">Alumno 9</th>
                      <th class="border-end" scope="row" colspan="3">Alumno 10</th>
                      <th class="border-end" scope="row" colspan="3">Alumno 11</th>
                    </tr>
                    <tr>
                        <th scope="col">Evento</th>
                        <th class="border-end" scope="col">Reloj</th>
                        <th scope="col">RND</th>
                        <th scope="col">Tiempo Generado</th>
                        <th class="border-end" scope="col">Prox. Evento</th>
                        <th scope="col">RND</th>
                        <th scope="col">Tiempo Generado</th>
                        <th scope="col">Prox evento 1</th>
                        <th scope="col">Prox evento 2</th>
                        <th scope="col">Prox evento 3</th>
                        <th scope="col">Prox evento 4</th>
                        <th scope="col">Prox evento 5</th>
                        <th class="border-end" scope="col">Prox evento 6</th>
                        <th scope="col">RND</th>
                        <th scope="col">A0</th>
                        <th scope="col">Tiempo Generado</th>
                        <th class="border-end" scope="col">Prox. Evento</th>
                        <th scope="col">RND 1</th>
                        <th scope="col">RND 2</th>
                        <th scope="col">Tiempo generado</th>
                        <th class="border-end" scope="col">Prox. Evento</th>
                        <th scope="col">Estado</th>
                        <th class="border-end" scope="col">Necesita mantenimiento</th>
                        <th scope="col">Estado</th>
                        <th class="border-end" scope="col">Necesita mantenimiento</th>
                        <th scope="col">Estado</th>
                        <th class="border-end" scope="col">Necesita mantenimiento</th>
                        <th scope="col">Estado</th>
                        <th class="border-end" scope="col">Necesita mantenimiento</th>
                        <th scope="col">Estado</th>
                        <th class="border-end" scope="col">Necesita mantenimiento</th>
                        <th scope="col">Estado</th>
                        <th class="border-end" scope="col">Necesita mantenimiento</th>
                        <th class="border-end" scope="col">Estado</th>
                        <th class="border-end" scope="col">Cola</th>
                        <th scope="col">Contador Al.</th>
                        <th scope="col">Contador Al. que se van</th>
                        <th scope="col">Contador Al. en cola</th>
                        <th scope="col">Acum. Tiempo espera</th>
                        <th scope="col">% Al. que se van</th>
                        <th class="border-end" scope="col">Promedio Espera</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Computadora</th>
                        <th class="border-end" scope="col">Llegada a cola</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Computadora</th>
                        <th class="border-end" scope="col">Llegada a cola</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Computadora</th>
                        <th class="border-end" scope="col">Llegada a cola</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Computadora</th>
                        <th class="border-end" scope="col">Llegada a cola</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Computadora</th>
                        <th class="border-end" scope="col">Llegada a cola</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Computadora</th>
                        <th class="border-end" scope="col">Llegada a cola</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Computadora</th>
                        <th class="border-end" scope="col">Llegada a cola</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Computadora</th>
                        <th class="border-end" scope="col">Llegada a cola</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Computadora</th>
                        <th class="border-end" scope="col">Llegada a cola</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Computadora</th>
                        <th class="border-end" scope="col">Llegada a cola</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Computadora</th>
                        <th class="border-end" scope="col">Llegada a cola</th>

                        <!-- <th scope="col">Estudiantes</th> -->
                    </tr>
                    </thead>
                    <tbody id='results_table'>
                    </tbody>
                </table>
              </div>
            </div>
        </div>
      </div>
      <div class="card card-body shadow my-3 py-4 px-5">
        <div class="container-fluid h-100">
          <div class="row h-100">
            <div class="col"><h4>Tablas de integracion</h4></div>
            <div>
              <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                {% for key in euler_tables.keys %}
                <li class="nav-item" role="presentation">
                  <button class="nav-link{% if forloop.first %} active{% endif %}" id="pills-{{key}}-tab" data-bs-toggle="pill" data-bs-target="#pills-{{key}}" type="button" role="tab" aria-controls="pills-{{key}}" aria-selected="true">{{key}}</button>
                </li>
                {% endfor %}
              </ul>
            </div>
            <div>
              <div class="tab-content" id="pills-tabContent">
                {% for key, value in euler_tables.items %}
                <div class="tab-pane fade{% if forloop.first %} show active{% endif %}" id="pills-{{key}}" role="tabpanel" aria-labelledby="pills-{{key}}-tab" tabindex="0">
                  <div class="overflow-scroll" style="max-height: 800px;"">
                    <table class="table h-100 table-hover table-striped">
                      <thead class="sticky-top top-0">
                        <tr>
                          <th class="border-start border-end" scope="row">Tiempo</th>
                          <th class="border-end" scope="row">A</th>
                          <th class="border-end" scope="row">dA</th>
                          <th class="border-end" scope="row">h*dA</th>
                          <th class="border-end" scope="row">At+1</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for item in value %}
                        <tr>
                          <th class="border-start border-end"  scope="row">{{item.time|floatformat:3}}</th>
                          <td class="border-end">{{item.y|floatformat:3}}</td>
                          <td class="border-end">{{item.dy|floatformat:3}}</td>
                          <td class="border-end">{{item.hdy|floatformat:3}}</td>
                          <td class="border-end">{{item.y1|floatformat:3}}</td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  const items = JSON.parse('{{history|safe}}');
  let showFrom = 0;
  let showTo = 1000;
  let pageSize = 1000;
  let pagesAmount = Math.ceil(items.length/pageSize);
  document.getElementById("lastBtn").setAttribute("onclick", `displayItems(${pagesAmount})`);

  function toFixed(num, fixed) {
    var re = new RegExp('^-?\\d+(?:\.\\d{0,' + (fixed || -1) + '})?');
    return num.toString().match(re)[0];
  }

  function format_students(students){
    students = Array.from({length: 11}, _ => undefined).map((student, index) => students[index])
    students_display = students.map((student) => {
      if (student === undefined) {
        return "<td>-</td><td>-</td><td>-</td>"
      }
      return `<td>${student.state ? student.state : "-"}</td><td>${student.computer ? student.computer : "-"}</td><td>${student.queue_arrival_time ? student.queue_arrival_time.toFixed(3) : "-"}</td>`
    })
    return students_display.join("")
  }

  const displayItems = (page) => {
    if (page === undefined) {
      return
    }
    const table = document.getElementById('results_table');
    showFrom = pageSize * (page - 1);
    showTo = pageSize * page;
    const paginatedItems = items.slice(showFrom, showTo);
    results = "";
    paginatedItems.forEach((item, i) => {
      results += `<tr>
        <th scope="row">${item.event_display}</th>
        <td>${toFixed(item.time, 3)}</td>
        <td>${item.arrival.random ? toFixed(item.arrival.random, 2) : "-"}</td>
        <td>${item.arrival.generated_time ? toFixed(item.arrival.generated_time, 2) : "-"}</td>
        <td>${item.arrival.next_time ? toFixed(item.arrival.next_time, 2) : "-"}</td>
        <td>${item.inscription.random ? toFixed(item.inscription.random, 2) : "-"}</td>
        <td>${item.inscription.generated_time ? toFixed(item.inscription.generated_time, 2) : "-"}</td>
        <td>${item.inscription.next_time_1 ? toFixed(item.inscription.next_time_1, 2) : "-"}</td>
        <td>${item.inscription.next_time_2 ? toFixed(item.inscription.next_time_2, 2) : "-"}</td>
        <td>${item.inscription.next_time_3 ? toFixed(item.inscription.next_time_3, 2) : "-"}</td>
        <td>${item.inscription.next_time_4 ? toFixed(item.inscription.next_time_4, 2) : "-"}</td>
        <td>${item.inscription.next_time_5 ? toFixed(item.inscription.next_time_5, 2) : "-"}</td>
        <td>${item.inscription.next_time_6 ? toFixed(item.inscription.next_time_6, 2) : "-"}</td>
        <td>${item.maintenance.random ? toFixed(item.maintenance.random, 2) : "-"}</td>
        <td>${item.maintenance.A0 ? toFixed(item.maintenance.A0, 2) : "-"}</td>
        <td>${item.maintenance.generated_time ? toFixed(item.maintenance.generated_time, 4) : "-"}</td>
        <td>${item.maintenance.next_time ? toFixed(item.maintenance.next_time, 2) : "-"}</td>
        <td>${item.return.random_1 ? toFixed(item.return.random_1, 2) : "-"}</td>
        <td>${item.return.random_2 ? toFixed(item.return.random_2, 2) : "-"}</td>
        <td>${item.return.generated_time ? toFixed(item.return.generated_time, 2) : "-"}</td>
        <td>${item.return.next_time ? toFixed(item.return.next_time, 2) : "-"}</td>
        <td>${item.computers[0].state}</td>
        <td>${item.computers[0].needs_maintenance}</td>
        <td>${item.computers[1].state}</td>
        <td>${item.computers[1].needs_maintenance}</td>
        <td>${item.computers[2].state}</td>
        <td>${item.computers[2].needs_maintenance}</td>
        <td>${item.computers[3].state}</td>
        <td>${item.computers[3].needs_maintenance}</td>
        <td>${item.computers[4].state}</td>
        <td>${item.computers[4].needs_maintenance}</td>
        <td>${item.computers[5].state}</td>
        <td>${item.computers[5].needs_maintenance}</td>
        <td>${item.technician.state}</td>
        <td>${item.queue.toString()}</td>
        <td>${item.total_students.toString()}</td>
        <td>${item.students_returning.toString()}</td>
        <td>${item.students_passed_queue.toString()}</td>
        <td>${item.total_wait_time.toFixed(3)}</td>
        <td>${item.students_leaving_percentage.toFixed(3)}</td>
        <td>${item.avg_wait_time.toFixed(3)}</td>
        ${format_students(item.students)}
      </tr>`
    });
    table.innerHTML = results;
    document.getElementById("pageLegend").innerHTML = `Pagina ${page} de ${pagesAmount} paginas`;
    document.getElementById("nextBtn").setAttribute("onclick", `displayItems(${page < pagesAmount ? page + 1 : page})`);
    document.getElementById("prevBtn").setAttribute("onclick", `displayItems(${page === 1 ? undefined : page - 1})`);
    document.getElementById("tableContainer").scrollTop = 0;
  }

  displayItems(1)

</script>
{% endblock %}
